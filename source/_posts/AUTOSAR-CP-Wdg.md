---
title: AUTOSAR-CP-Wdg
date: 2024-02-23 15:59:49
tags:
  - AUTOSAR-CP
  - BSW
  - Wdg
categories:
  - AUTOSAR
cover: AUTOSAR_04.png
---

> 本文章所参考的 AUTOSAR 标准为 4.4.0 版本

# Watchdog 基本功能

`Watchdog`，即看门狗，其主要功能是在设备无人值守时，自动复位系统，确保系统持续稳定运行。这一功能对于关键安全系统至关重要，同时对于非关键安全系统也具有重要意义。

在实际应用中，由于硬件老化、外部电磁干扰等因素，软件在运行过程中可能出现不可预测的行为。若无看门狗机制，这些问题可能导致设备故障，特别是在恶劣环境如沙漠地带，将显著增加不必要的维护成本。

对于汽车而言，ECU 中的软件同样可能受到电磁干扰、高温等环境因素的影响，从而引发程序异常。然而，正是看门狗机制的存在，在关键时刻能够触发系统复位，及时将设备恢复到正常工作状态，有效防止潜在风险。

看门狗的实现方式主要有硬件看门狗和软件看门狗两种。硬件看门狗依赖硬件机制，通过定时器原理实现，软件仅负责启动定时器；而软件看门狗则完全由软件控制定时器的启动和更新。

# 硬件看门狗

如上所述，硬件看门狗主要依赖自身的定时器来实现其功能，因此被俗称为“硬狗”。常见的硬件看门狗形式包括 `MCU` 内部自带的看门狗、`PMIC` 中内嵌的看门狗，以及外部的独立看门狗等。

在选择适合的硬件看门狗时，需根据系统的具体需求来决定，无法一概而论。不过，在使用硬件看门狗时，需特别注意以下两点：

- 首先，要确保所选硬件看门狗的最大超时时间能满足系统的设计需求。如果超时时间设置过短，可能会导致系统的不稳定性，从而误触发看门狗机制。

- 其次，对于关键安全系统而言，通常要求看门狗一旦启动就不允许被关闭。此外，还需考虑系统上电后看门狗的默认状态。如果是默认启动看门狗，那么软件就需要在芯片上电后立即进行喂狗操作或重置看门狗。同时，还需要设计一种在刷件或调试软件前的物理关闭看门狗的动作。

关于喂狗方式，硬件看门狗可以采用 `GPIO`、`IIC` 或 `SPI` 等通讯方式。由于不同的通讯方式对芯片的硬件资源有不同的要求，因此应选择相对简单可靠的通讯方式进行喂狗。

# 软件看门狗

软件看门狗，亦称为“软狗”，主要通过软件定时器实现其功能。虽然名为软件，但其时间基准仍依赖于硬件外设上的硬件定时器。

以 `ostick` 为例，我们利用它来计时。通过运行软狗监控的定时器任务，不断递减主程序计数器。其他任务则负责重置该定时器。若软件检测到主程序的定时器归零，这意味着其他任务未能正常执行，此时可以触发主动复位，实现看门狗功能。

在配置软件看门狗时，通常建议将运行软狗的主任务优先级设置得比被监控的任务高。当与硬件看门狗结合使用时，通常会将软狗的主任务与硬件看门狗的喂狗任务置于同一任务中，以确保两者之间的协调与同步。

# AUTOSAR Watchdog Driver

该模块具备初始化硬件看门狗、调整操作模式以及设定触发喂狗机制等功能。看门狗可根据其位置分为内部与外部两种类型，其中，内置于芯片内的称为内部看门狗，而外置的则称为外部看门狗。

无论是内部还是外部看门狗，`Watchdog Driver` 所使用的 `API` 都应保持统一。内部看门狗驱动属于 `MCAL` 层，而外部看门狗则属于 `ECU` 硬件抽象层。对于外部看门狗，其驱动需依赖 MCAL 中的其他驱动，如 `GPIO`、`IIC` 或 `SPI` 等，以执行喂狗操作。

## 内部看门狗

内部看门狗作为芯片内置的硬件监控机制，其驱动通常由芯片厂商提供。在使用前，务必确认其复位动作类型，避免冷复位或复位不完全等情形，以确保其能有效实现安全监控。然而，由于内部看门狗与芯片硬件紧密相关，若芯片本身存在硬件故障，可能会导致内部看门狗失效，从而陷入自保困境。因此，在关键安全系统中，单纯依赖内部看门狗可能不足以确保功能安全，此时需结合外部看门狗来共同保障系统的稳定运行。

## 外部看门狗

外部看门狗独立于受保护的芯片，可以是专门的硬件看门狗设备，通常达到 QM 等级。另一种类型是集成在 `PMIC` 内部的看门狗，这类设备通常能满足 `ASIL B` 或 `ASIL D` 功能安全等级的要求。在关键安全系统中，外部看门狗通常是必不可少的，它对于保障系统稳定性至关重要。相比之下，内部看门狗虽然有其作用，但在确保系统安全方面，外部看门狗显得更为重要。

## 看门狗控制模式

在 `AUTOSAR` 架构中，`Watchdog` 针对看门狗控制模式定义了以下三种模式：

- `Off Mode(WDGIF_OFF_MODE)`：代表看门狗关闭状态。对于关键安全系统，此模式通常不可用，即看门狗一旦被激活，就不能被关闭。
- `Slow Mode(WDGIF_SLOW_MODE)`：适用于系统启动初始化过程，提供较长的喂狗窗口时间。
- `Fast Mode(WDGIF_FAST_MODE)`：是系统正常运行时的标准喂狗模式，具有较短的喂狗窗口时间。

## 看门狗喂狗时序

在 `Watchdog` 的操作过程中，存在三个关键的函数调用场景，分别对应于 `Watchdog` 的初始化、触发喂狗动作以及模式变更。

- `Watchdog` 初始化：此过程通过 `EcuM（Electronic Control Unit Manager）`模块发起，调用 `Wdg_Init` 函数来完成 `Watchdog` 的初始化配置。这一步骤确保了看门狗在启动时就处于正确的配置状态，为后续操作提供了基础。
- 触发看门狗喂狗：当系统需要在特定条件下喂狗时，通过 `WdgM（Watchdog Manager）`模块调用 `WdgIf（Watchdog Interface）`模块提供的 `WdgIf_SetTriggerCondition` 函数。这一函数的作用是设置触发条件，当这些条件满足时，将触发底层驱动执行喂狗动作，确保看门狗不会因超时而触发复位。
- 改变看门狗模式：随着系统运行状态的变化，可能需要对看门狗的模式进行调整。这同样通过 `WdgM` 模块实现，调用 `WdgIf` 模块提供的 `WdgIf_SetMode` 函数来完成模式变更。通过此函数，系统可以在 `Slow Mode`（慢模式）和 `Fast Mode`（快模式）之间切换，以适应不同的运行场景。

这些函数调用场景共同构成了看门狗喂狗的时序逻辑，确保了看门狗在系统中的有效性和安全性。

![image-20240226112708296](AUTOSAR-CP-Wdg/image-20240226112708296.png)

如下图所示，展示了 `Wathdog` 抽象层（`WdgIf`）与底层看门狗硬件之间的交互时序。从图中可以看出，当 `WdgIf` 模块需要触发喂狗动作时，它会调用`WdgIf_SetTriggerCondition`函数。这个函数是 `WdgIf` 模块提供的接口，用于设置触发喂狗的条件。

在`WdgIf_SetTriggerCondition`函数内部，它会继续调用底层 `Wdg` 驱动中的 `Wdg_SetTriggerCondition` 函数。这个底层函数直接与硬件交互，负责实现具体的喂狗动作。通过调用 `Wdg_SetTriggerCondition`函数，看门狗硬件会根据设定的条件执行喂狗操作，从而防止因超时而导致的系统复位。

这种交互时序确保了看门狗机制的有效性和可靠性。通过 `WdgIf` 模块与底层 `Wdg` 驱动的协同工作，系统能够在需要时及时触发喂狗动作，保持看门狗的运行状态，从而防止因系统故障而导致的意外复位。这对于关键安全系统来说尤为重要，能够确保系统的稳定性和安全性。

![image-20240226112921235](AUTOSAR-CP-Wdg/image-20240226112921235.png)

## API 列表

| 函数名                      | 函数功能                                                                                         |
| --------------------------- | ------------------------------------------------------------------------------------------------ |
| **Wdg_Init**                | 初始化看门狗                                                                                     |
| **Wdg_SetMode**             | 设置看门狗模块，模式可分为：<br />- WDGIF_OFF_MODE<br />- WDGIF_SLOW_MODE<br />- WDGIF_FAST_MODE |
| **Wdg_SetTriggerCondition** | 设置看门狗触发计数器的超时值                                                                     |
| **Wdg_GetVersionInfo**      | 返回 Wdg 模块的版本信息                                                                          |

# 软件实现

待更新

# 参考

- https://www.zhihu.com/tardis/zm/art/651467544?source_id=1005
